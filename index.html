<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Investment Comparison Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    #graph-container {
      flex: 3;
      padding: 20px;
    }
    #control-panel {
      flex: 1;
      padding: 20px;
      background-color: #f5f5f5;
      border-left: 1px solid #ccc;
      overflow-y: auto;
    }
    .ticker-row {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    .ticker-row input {
      flex: 1;
    }
    .ticker-row button {
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <div id="graph-container">
    <canvas id="investmentChart"></canvas>
  </div>
  <div id="control-panel">
    <label>Starting Investment:<br>
      <input type="number" id="startingInvestment" value="1000">
    </label><br><br>

    <label>Date Start:<br>
      <input type="date" id="startDate">
    </label><br><br>

    <label>Date End:<br>
      <input type="date" id="endDate">
    </label><br><br>

    <div id="tickerInputs">
      <div class="ticker-row">
        <input type="text" class="ticker" value="QQQ" />
        <button onclick="deleteTickerRow(this)">❌</button>
      </div>
      <div class="ticker-row">
        <input type="text" class="ticker" placeholder="Enter ticker..." />
        <button onclick="deleteTickerRow(this)">❌</button>
      </div>
    </div>
    <button onclick="addTickerRow()">Add Ticker</button>
    <br><br>
    <button onclick="updateGraph()">Update Graph</button>
  </div>

  <script>
    const ctx = document.getElementById('investmentChart').getContext('2d');
    let investmentChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [] },
      options: {
        responsive: true,
        scales: { x: { type: 'time', time: { unit: 'month' } } }
      }
    });

    function addTickerRow() {
      const container = document.getElementById('tickerInputs');
      const div = document.createElement('div');
      div.className = 'ticker-row';
      div.innerHTML = `
        <input type="text" class="ticker" placeholder="Enter ticker...">
        <button onclick="deleteTickerRow(this)">❌</button>
      `;
      container.appendChild(div);
    }

    function deleteTickerRow(button) {
      const row = button.parentElement;
      row.remove();
    }

    async function updateGraph() {
      const startingInvestment = parseFloat(document.getElementById('startingInvestment').value);
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const tickers = Array.from(document.getElementsByClassName('ticker'))
        .map(el => el.value.trim().toUpperCase())
        .filter(t => t);

      const datasets = await Promise.all(tickers.map(async (ticker) => {
        const prices = await fetchYahooData(ticker, startDate, endDate);
        if (!prices || prices.length === 0) return null;

        return {
          label: ticker,
          data: prices.map(p => ({ x: p.date, y: (p.close / prices[0].close) * startingInvestment })),
          borderWidth: 2
        };
      }));

      investmentChart.data.labels = datasets[0]?.data.map(d => d.x) || [];
      investmentChart.data.datasets = datasets.filter(Boolean);
      investmentChart.update();
    }

    async function fetchYahooData(ticker, start, end) {
      const startTime = Math.floor(new Date(start).getTime() / 1000);
      const endTime = Math.floor(new Date(end).getTime() / 1000);

      const url = `https://corsproxy.io/?url=` + encodeURIComponent(
        `https://query1.finance.yahoo.com/v7/finance/download/${ticker}?period1=${startTime}&period2=${endTime}&interval=1d&events=history&includeAdjustedClose=true`
      );

      try {
        const res = await fetch(url);
        const csv = await res.text();
        console.log(`Fetching data from: ${url}`);
        const rows = csv.split('\n').slice(1); // skip header
        const prices = rows.map(row => {
          const [date, , , , close] = row.split(',');
          return {
            date,
            close: parseFloat(close)
          };
        }).filter(p => !isNaN(p.close));

        return prices;
      } catch (err) {
        console.error(`Error fetching Yahoo data for ${ticker}:`, err);
        return null;
      }
    }
  </script>
</body>
</html>
